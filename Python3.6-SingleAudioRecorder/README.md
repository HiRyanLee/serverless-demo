# 概述

基于云函数+TRTC+COS+ffmpeg实现单流音频录制。可配合CFS实现长时间单流音频录制，并将生成的FLV音频文件转码MP3格式转储到指定的COS桶持久保存。

# 使用指导

## 前置条件

1、基于单流录制demo创建函数； 

2、创建函数URL触发器；

3、TRTC实时音视频服务控制台创建应用，记录下sdkAppId。

## 开启录制

通过调用函数URL开启单流音频录制。接口参数说明：

```
{
	"sdkAppId": xxxxx,  // trtc应用ID，整数类型。从trtc服务控制台应用管理页面获取
	"roomId": 12345,  // 房间ID，uint32类型。该参数与strRoomId二选一。
	"strRoomId": "12345", // 字符串类型房间ID。与RoomId二选一，当roomId和strRoomId参数同时配置时，使用roomId作为房间参数。
	"userId": "user_xxxx", // 录制用户ID。观众角色，使用该用户完成录制。
	"userSig": "xxxx", // 用户进房鉴权密钥，可在trtc服务控制台自动生成，也可通过trtc提供的sdk自动计算得到。
	"cosConfig": {
		"region": "ap-xxxx", // 存储音频录制文件的cos桶区域
		"bucket": "cy-scf-gz-1253970226", // 存储音频录制文件的cos桶
		"path": "/record" // 存储音频录制文件的cos桶目录
	},
	"callback": "xxxx" // 录制结果回调地址
}
```

说明：

1、roomId和strRoomId建议只传一个，需要确认主播角色的用户进房选择的字符串类型的房间号还是整数类型的房间号，否则主播角色的用户进入的房间和观众角色的录制用户进入的房间不一样，导致无法录制。

2、cos桶需提前创建好，否则转储音频录制文件会失败，并确保角色具有cos写权限。

3、如果云函数不绑定CFS文件系统，将使用本地/tmp缓存音频录制文件，/tmp目录可用空间512MB，需注意空间限制。建议云函数绑定CFS文件系统，同时配置环境变量"CFS_PATH"将录制文件保存到CFS文件系统中。

## 结束录制

通过调用TRTC服务提供的踢出房间接口主动结束录制。调用该接口将录制用户踢出房间，录制结束。如果房间中没有主播角色用户，等待超时后结束录制。

